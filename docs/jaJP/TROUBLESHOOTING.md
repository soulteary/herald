# Herald トラブルシューティングガイド

このガイドは、Herald OTP および検証コードサービスの一般的な問題を診断して解決するのに役立ちます。

## 目次

- [検証コードが受信されない](#検証コードが受信されない)
- [検証コードエラー](#検証コードエラー)
- [401 認証エラー](#401-認証エラー)
- [レート制限の問題](#レート制限の問題)
- [Redis 接続の問題](#redis-接続の問題)
- [プロバイダー送信失敗](#プロバイダー送信失敗)
- [パフォーマンスの問題](#パフォーマンスの問題)

## 検証コードが受信されない

### 症状
- ユーザーが SMS または電子メールで検証コードを受信していないと報告
- チャレンジの作成は成功するが、コードが配信されない

### 診断手順

1. **プロバイダー接続を確認**
   ```bash
   # Herald ログでプロバイダーエラーを確認
   grep "send_failed\|provider" /var/log/herald.log
   ```

2. **プロバイダー設定を確認**
   - SMTP 設定を確認（電子メール用）：`SMTP_HOST`、`SMTP_PORT`、`SMTP_USER`、`SMTP_PASSWORD`
   - SMS プロバイダー設定を確認：`SMS_PROVIDER`、`ALIYUN_ACCESS_KEY` など
   - プロバイダーの認証情報が正しいことを確認

3. **Prometheus メトリクスを確認**
   ```promql
   # 送信失敗率を確認
   rate(herald_otp_sends_total{result="failed"}[5m]) / rate(herald_otp_sends_total[5m])
   
   # プロバイダー別の送信成功を確認
   rate(herald_otp_sends_total{result="success"}[5m]) by (provider)
   ```

4. **監査ログを確認**
   - `send_failed` イベントの監査ログを確認
   - プロバイダーのエラーコードとメッセージを確認
   - 宛先アドレスが有効であることを確認

5. **プロバイダーを直接テスト**
   - SMTP 接続を手動でテスト
   - SMS プロバイダー API を直接テスト
   - プロバイダーエンドポイントへのネットワーク接続を確認

### 解決策

- **プロバイダー設定の問題**: プロバイダーの認証情報と設定を更新
- **ネットワークの問題**: ファイアウォールルールとネットワーク接続を確認
- **プロバイダーのレート制限**: プロバイダーに超過しているレート制限があるか確認
- **無効な宛先**: 電子メールアドレスと電話番号が有効であることを確認

## 検証コードエラー

### 症状
- ユーザーが「無効なコード」エラーを報告
- 正しいコードでも検証が失敗する
- チャレンジが期限切れまたはロックされているように見える

### 診断手順

1. **チャレンジステータスを確認**
   ```bash
   # Redis でチャレンジデータを確認
   redis-cli GET "otp:ch:{challenge_id}"
   ```

2. **チャレンジの有効期限を確認**
   - `CHALLENGE_EXPIRY` 設定を確認（デフォルト：5 分）
   - システム時刻が同期されていることを確認（NTP）
   - チャレンジが期限切れかどうかを確認

3. **試行回数を確認**
   - `MAX_ATTEMPTS` 設定を確認（デフォルト：5）
   - 試行回数が多すぎてチャレンジがロックされているか確認
   - 試行履歴の監査ログを確認

4. **Prometheus メトリクスを確認**
   ```promql
   # 検証失敗理由を確認
   rate(herald_otp_verifications_total{result="failed"}[5m]) by (reason)
   
   # ロックされたチャレンジを確認
   rate(herald_otp_verifications_total{result="failed",reason="locked"}[5m])
   ```

5. **監査ログを確認**
   - 検証試行と結果を確認
   - コード形式が期待される形式と一致することを確認
   - タイミングの問題を確認

### 解決策

- **期限切れチャレンジ**: ユーザーは新しい検証コードをリクエストする必要がある
- **試行回数が多すぎる**: チャレンジがロックされているため、ロックアウト期間を待つか、新しいチャレンジをリクエスト
- **コード形式の不一致**: コードの長さが `CODE_LENGTH` 設定と一致することを確認
- **時刻同期**: システムクロックが同期されていることを確認

## 401 認証エラー

### 症状
- API リクエストが 401 認証エラーを返す
- ログに認証失敗が記録される
- サービス間通信が失敗する

### 診断手順

1. **認証方法を確認**
   - 使用されている認証方法を確認（mTLS、HMAC、API キー）
   - 認証ヘッダーが存在するか確認

2. **HMAC 認証の場合**
   ```bash
   # HMAC_SECRET が設定されていることを確認
   echo $HMAC_SECRET
   
   # タイムスタンプが 5 分のウィンドウ内にあることを確認
   # 署名計算が Herald の実装と一致することを確認
   ```

3. **API キー認証の場合**
   ```bash
   # API_KEY が設定されていることを確認
   echo $API_KEY
   
   # X-API-Key ヘッダーが設定されたキーと一致することを確認
   ```

4. **mTLS 認証の場合**
   - クライアント証明書が有効であることを確認
   - 証明書チェーンが信頼されていることを確認
   - TLS 接続が確立されていることを確認

5. **Herald ログを確認**
   ```bash
   # 認証エラーを確認
   grep "unauthorized\|invalid_signature\|timestamp_expired" /var/log/herald.log
   ```

### 解決策

- **認証情報の欠落**: `API_KEY` または `HMAC_SECRET` 環境変数を設定
- **無効な署名**: HMAC 署名計算が Herald の実装と一致することを確認
- **タイムスタンプの期限切れ**: クライアントとサーバーのクロックが同期されていることを確認（5 分以内）
- **証明書の問題**: mTLS 証明書が有効で信頼されていることを確認

## レート制限の問題

### 症状
- ユーザーが「レート制限超過」エラーを報告
- 正当なリクエストがブロックされている
- レート制限ヒットメトリクスが高い

### 診断手順

1. **レート制限設定を確認**
   ```bash
   # レート制限設定を確認
   echo $RATE_LIMIT_PER_USER
   echo $RATE_LIMIT_PER_IP
   echo $RATE_LIMIT_PER_DESTINATION
   echo $RESEND_COOLDOWN
   ```

2. **Prometheus メトリクスを確認**
   ```promql
   # スコープ別のレート制限ヒットを確認
   rate(herald_rate_limit_hits_total[5m]) by (scope)
   
   # レート制限ヒット率を確認
   rate(herald_rate_limit_hits_total[5m])
   ```

3. **Redis キーを確認**
   ```bash
   # レート制限キーを確認
   redis-cli KEYS "otp:rate:*"
   
   # 特定のレート制限キーを確認
   redis-cli GET "otp:rate:user:{user_id}"
   ```

4. **使用パターンを分析**
   - 正当なユーザーが制限に達しているか確認
   - 潜在的な悪用やボット活動を特定
   - チャレンジ作成パターンを確認

### 解決策

- **レート制限の調整**: 正当なユーザーが影響を受けている場合は制限を増やす
- **ユーザー教育**: ユーザーにレート制限とクールダウン期間について通知
- **悪用防止**: 疑わしい悪用に対して追加のセキュリティ対策を実装
- **再送信クールダウン**: ユーザーは `RESEND_COOLDOWN` 期間を待つ必要がある（デフォルト：60 秒）

## Redis 接続の問題

### 症状
- サービスが起動しない
- ヘルスチェックが異常を返す
- チャレンジの作成/検証が失敗する
- Redis レイテンシメトリクスが高い

### 診断手順

1. **Redis 接続性を確認**
   ```bash
   # Redis 接続をテスト
   redis-cli -h $REDIS_ADDR -p 6379 PING
   ```

2. **設定を確認**
   ```bash
   # Redis 設定を確認
   echo $REDIS_ADDR
   echo $REDIS_PASSWORD
   echo $REDIS_DB
   ```

3. **Redis の健全性を確認**
   ```bash
   # Redis 情報を確認
   redis-cli INFO
   
   # メモリ使用量を確認
   redis-cli INFO memory
   ```

4. **Prometheus メトリクスを確認**
   ```promql
   # Redis レイテンシを確認
   histogram_quantile(0.99, rate(herald_redis_latency_seconds_bucket[5m]))
   
   # Redis 操作エラーを確認
   rate(herald_redis_latency_seconds_count[5m])
   ```

5. **Herald ログを確認**
   ```bash
   # Redis エラーを確認
   grep "Redis\|redis" /var/log/herald.log | grep -i error
   ```

### 解決策

- **接続の問題**: `REDIS_ADDR` が正しく、Redis にアクセス可能であることを確認
- **認証の問題**: `REDIS_PASSWORD` が正しいことを確認
- **データベースの選択**: `REDIS_DB` が正しいことを確認（デフォルト：0）
- **パフォーマンスの問題**: Redis のメモリ使用量を確認し、スケーリングを検討
- **ネットワークの問題**: ネットワーク接続とファイアウォールルールを確認

## プロバイダー送信失敗

### 症状
- メトリクスで送信失敗率が高い
- ログに `send_failed` エラーが記録される
- プロバイダー固有のエラーメッセージ

### 診断手順

1. **プロバイダーメトリクスを確認**
   ```promql
   # プロバイダー別の送信失敗率を確認
   rate(herald_otp_sends_total{result="failed"}[5m]) by (provider)
   
   # プロバイダー別の送信継続時間を確認
   histogram_quantile(0.95, rate(herald_otp_send_duration_seconds_bucket[5m])) by (provider)
   ```

2. **プロバイダーログを確認**
   - プロバイダー固有のエラーメッセージを確認
   - プロバイダーエラーの監査ログを確認
   - プロバイダー API の応答コードを確認

3. **プロバイダー接続をテスト**
   - SMTP 接続を手動でテスト
   - SMS プロバイダー API を直接テスト
   - プロバイダーの認証情報を確認

4. **プロバイダーステータスを確認**
   - プロバイダーのステータスページを確認
   - プロバイダー API が動作していることを確認
   - プロバイダーのレート制限を確認

### 解決策

- **プロバイダーの障害**: プロバイダーがサービスを復旧するのを待つ
- **認証情報の問題**: プロバイダーの認証情報を更新
- **レート制限**: プロバイダーのレート制限が超過されているか確認
- **設定の問題**: プロバイダーの設定が正しいことを確認
- **ネットワークの問題**: プロバイダーへのネットワーク接続を確認

## パフォーマンスの問題

### 症状
- 応答時間が遅い
- レイテンシメトリクスが高い
- タイムアウトエラー
- リソース使用量が高い

### 診断手順

1. **応答時間を確認**
   ```promql
   # 送信継続時間を確認
   histogram_quantile(0.95, rate(herald_otp_send_duration_seconds_bucket[5m]))
   
   # Redis レイテンシを確認
   histogram_quantile(0.99, rate(herald_redis_latency_seconds_bucket[5m]))
   ```

2. **リソース使用量を確認**
   ```bash
   # CPU とメモリを確認
   top -p $(pgrep herald)
   
   # Goroutine 数を確認
   curl http://localhost:8082/debug/pprof/goroutine?debug=1
   ```

3. **リクエストパターンを確認**
   - リクエスト率を確認
   - ピーク使用時間を特定
   - トラフィックスパイクを確認

4. **Redis パフォーマンスを確認**
   ```bash
   # Redis スローログを確認
   redis-cli SLOWLOG GET 10
   
   # Redis メモリを確認
   redis-cli INFO memory
   ```

### 解決策

- **リソースのスケーリング**: CPU/メモリの割り当てを増やす
- **Redis の最適化**: Redis Cluster を使用するか、クエリを最適化
- **プロバイダーの最適化**: より高速なプロバイダーを使用するか、プロバイダー呼び出しを最適化
- **キャッシング**: 頻繁にアクセスされるデータのキャッシングを実装
- **負荷分散**: 複数のインスタンス間で負荷を分散

## ヘルプの取得

問題を解決できない場合：

1. **ログを確認**: 詳細なエラーメッセージについて Herald ログを確認
2. **メトリクスを確認**: パターンについて Prometheus メトリクスを確認
3. **ドキュメントを確認**: [API.md](API.md) と [DEPLOYMENT.md](DEPLOYMENT.md) を確認
4. **問題を報告**: 以下を含む問題を作成：
   - エラーメッセージとログ
   - 設定（シークレットなし）
   - 再現手順
   - 期待される動作と実際の動作

## 関連ドキュメント

- [API ドキュメント](API.md) - API エンドポイントの詳細
- [デプロイメントガイド](DEPLOYMENT.md) - デプロイメントと設定
- [モニタリングガイド](MONITORING.md) - モニタリングとメトリクス
